import AddIcon from "@mui/icons-material/Add";
import DeleteForeverIcon from "@mui/icons-material/DeleteForever";
import EditNoteIcon from "@mui/icons-material/EditNote";
import CloseIcon from "@mui/icons-material/Close";
import { GridToolbar } from "@mui/x-data-grid";
import {
  Button, Checkbox, FormControlLabel, Grid, IconButton, Modal, Paper, TextField, Typography,
} from "@mui/material";
import { DataGrid } from "@mui/x-data-grid";
import axios from "axios";
import * as React from "react";
import Swal from "sweetalert2";
import { BASE_URL } from "../Constant";
import Loader from "../components/Loader";
import { CheckboxInputs } from "../components/Component";
import { debounce } from "lodash"; // Debouncing helper function
import { Controller, useForm } from "react-hook-form"; // Importing React Hook Form

const Department = () => {
  const [loaderOpen, setLoaderOpen] = React.useState(false);
  const [imgData, setImgData] = React.useState([]);
  const [on, setOn] = React.useState(false);
  const [SaveUpdateButton, setSaveUpdateButton] = React.useState("UPDATE");
  const [ClearUpdateButton, setClearUpdateButton] = React.useState("RESET");
  const [totalRows, setTotalRows] = React.useState("");
  const [currentPage, setCurrentPage] = React.useState(0);
  const [loading, setLoading] = React.useState(false);
  const [searchText, setSearchText] = React.useState("");
  const limit = 20; // Fixed page size
  const originalDataRef = React.useRef(null);

  // React Hook Form initialization
  const { register, handleSubmit, control, setValue, reset, formState: { errors } } = useForm({
    defaultValues: {
      DeptNameEN: "",
      DeptNameMR: "",
      Status: 1, // Default to checked (1)
    },
  });
  const clearFormData = () => {
    if (ClearUpdateButton === "CLEAR") {
      reset({
        DeptNameEN: "",
        DeptNameMR: "",
        Status: 1,
      });
    }
    if (ClearUpdateButton === "RESET") {
      reset(originalDataRef.current);
    }
  };

  const handleClose = () => setOn(false);

  const handleOnSave = () => {
    setSaveUpdateButton("SAVE");
    setClearUpdateButton("CLEAR");
    setOn(true);
    clearFormData();
  };

  const validationAlert = (message) => {
    Swal.fire({
      position: "center",
      icon: "warning",
      toast: true,
      title: message,
      showConfirmButton: false,
      timer: 1500,
    });
  };

  const handleSubmitForm = async (formData) => {
    try {
      const requiredFields = ["DeptNameEN", "DeptNameMR"];
      const emptyRequiredFields = requiredFields.filter(
        (field) => !formData[field]?.trim()
      );

      if (emptyRequiredFields.length > 0) {
        validationAlert("Please fill in all required fields");
        return;
      }

      const payload = {
        Id: null || formData.Id,
        DeptNameEN: formData.DeptNameEN,
        DeptNameMR: formData.DeptNameMR,
        Status: formData.Status,
      };
      let response;

      if (SaveUpdateButton === "SAVE") {
        setLoaderOpen(true);
        response = await axios.post(`${BASE_URL}Department`, payload);
      } else {
        if (!formData.Id) {
          Swal.fire({
            position: "center",
            icon: "error",
            toast: true,
            title: "Update Failed",
            text: "Invalid Department ID",
            showConfirmButton: true,
          });
          return;
        }

        const result = await Swal.fire({
          text: "Do you want to Update...?",
          icon: "warning",
          showCancelButton: true,
          confirmButtonColor: "#3085d6",
          cancelButtonColor: "#d33",
          confirmButtonText: "Yes, Update it!",
        });

        if (!result.isConfirmed) {
          return;
        }

        setLoaderOpen(true);
        response = await axios.put(`${BASE_URL}Department/${formData.Id}`, payload);
      }

      setLoaderOpen(false);

      if (response.data.success) {
        Swal.fire({
          position: "center",
          icon: "success",
          toast: true,
          title: SaveUpdateButton === "SAVE"
            ? "Department Added Successfully"
            : "Department Updated Successfully",
          showConfirmButton: false,
          timer: 1500,
        });
        handleClose();
        getAllImgList(currentPage, searchText);
      } else {
        throw new Error(response.data.message || "Unexpected error");
      }
    } catch (error) {
      setLoaderOpen(false);
      Swal.fire({
        position: "center",
        icon: "error",
        toast: true,
        title: "Failed",
        text: error.message || "Something went wrong",
        showConfirmButton: true,
      });
    }
  };

  const getAllImgList = async (page = 0, searchText = "") => {
    try {
      setLoading(true);
      let apiUrl = `${BASE_URL}Department/ByPage/${page}/${limit}`;
      if (searchText) {
        apiUrl = `${BASE_URL}Department/ByPage/search/${searchText}/${page}/${limit}`;
      }

      const response = await axios.get(apiUrl);
      if (response.data && response.data.values) {
        setImgData(
          response.data.values.map((item, index) => ({
            ...item,
            id: page * limit + index + 1,
          }))
        );
        setTotalRows(response.data.count);
      }
    } catch (error) {
      console.error("Error fetching data:", error);
    } finally {
      setLoading(false);
    }
  };

  // Debounced search function
  const debouncedSearch = React.useMemo(
    () => debounce((searchText) => {
      getAllImgList(currentPage, searchText);
    }, 500), [currentPage]
  );

  React.useEffect(() => {
    debouncedSearch(searchText);
    return () => debouncedSearch.cancel(); // Cancel the debounced search when component unmounts
  }, [searchText]);

  const handleDelete = async (rowData) => {
    Swal.fire({
      text: "Are you sure you want to delete?",
      icon: "warning",
      showCancelButton: true,
      confirmButtonColor: "#d33",
      cancelButtonColor: "#3085d6",
      confirmButtonText: "Yes, delete it!",
    }).then(async (result) => {
      if (result.isConfirmed) {
        setLoaderOpen(true);
        try {
          const response = await axios.delete(`${BASE_URL}Department/${rowData.Id}`);
          setLoaderOpen(false);
          if (response.data && response.data.success) {
            Swal.fire({
              position: "center",
              icon: "success",
              toast: true,
              title: "Department deleted successfully",
              showConfirmButton: false,
              timer: 1500,
            });
            getAllImgList(currentPage, searchText);
          } else {
            Swal.fire({
              position: "center",
              icon: "error",
              toast: true,
              title: "Failed",
              text: `Unexpected response: ${JSON.stringify(response.data)}`,
              showConfirmButton: true,
            });
          }
        } catch (error) {
          setLoaderOpen(false);
          Swal.fire({
            position: "center",
            icon: "error",
            toast: true,
            title: "Failed",
            text: error.message || "Something went wrong",
            showConfirmButton: true,
          });
        }
      }
    });
  };

  const columns = [
    {
      field: "actions",
      headerName: "Action",
      width: 150,
      sortable: false,
      renderCell: (params) => (
        <strong>
          <IconButton color="primary" onClick={() => handleUpdate(params.row)}>
            <EditNoteIcon />
          </IconButton>
          <Button size="medium" sx={{ color: "red" }} onClick={() => handleDelete(params.row)}>
            <DeleteForeverIcon />
          </Button>
        </strong>
      ),
    },
    { field: "id", headerName: "Sr.No", width: 100, sortable: true },
    { field: "DeptNameEN", headerName: "Department Name", width: 500, sortable: false },
    { field: "DeptNameMR", headerName: "Department Name Marathi", width: 500, sortable: false },
    {
      field: "Status",
      headerName: "Status",
      width: 200,
      sortable: false,
      valueGetter: (params) => (params.row.Status === 1 ? "Active" : "Inactive"),
      renderCell: (params) => {
        const isActive = params.row.Status === 1;
        return (
          <button style={isActive ? activeButtonStyle : inactiveButtonStyle} disabled>
            {isActive ? "Active" : "Inactive"}
          </button>
        );
      },
    },
  ];

  const buttonStyles = {
    border: "none",
    borderRadius: "4px",
    padding: "4px 8px",
    fontSize: "12px",
    cursor: "pointer",
    color: "#fff",
    width: 55,
  };

  const activeButtonStyle = {
    ...buttonStyles,
    backgroundColor: "green",
  };

  const inactiveButtonStyle = {
    ...buttonStyles,
    backgroundColor: "#dc3545",
  };

  const handleUpdate = async (rowData) => {
    setSaveUpdateButton("UPDATE");
    setClearUpdateButton("RESET");
    setOn(true);
    try {
      setLoading(true);
      const apiUrl = `${BASE_URL}Department/ById/${rowData.Id}`;
      const response = await axios.get(apiUrl);
      if (response.data && response.data.values) {
        const department = response.data.values;
        originalDataRef.current = department;
        setValue("Id", department.Id)
        setValue("DeptNameEN", department.DeptNameEN);
        setValue("DeptNameMR", department.DeptNameMR);
        setValue("Status", department.Status);
      }
    } catch (error) {
      console.error("Error fetching department data:", error);
    } finally {
      setLoading(false);
    }
  };

  return (
    <>
    {loaderOpen && <Loader open={loaderOpen} />}
    <Modal
      open={on}
      onClose={handleClose}
      sx={{
        backdropFilter: "blur(5px)",
        backgroundColor: "rgba(0, 0, 0, 0.3)",
        // zIndex: 1200,
      }}
    >
      <Paper
        elevation={10}
        sx={{
          width: "90%",
          maxWidth: 400,
          // bgcolor: "#E6E6FA",
          position: "absolute",
          top: "50%",
          left: "50%",
          transform: "translate(-50%, -50%)",
          justifyContent: "center",
        }}
      >
        <Grid
          container
          item
          xs={12}
          spacing={4}
          display={"flex"}
          flexDirection={"column"}
          padding={3}
          justifyContent={"center"}
          marginBottom={"14px"}
          onSubmit={handleSubmit(handleSubmitForm)}
          component={"form"}
        >
          <Grid item xs={12}    sx={{ display: "flex", justifyContent: "space-between" }}>
            <Typography fontWeight="bold" textAlign={"center"}>
              Add Department
            </Typography>
            <IconButton onClick={handleClose}>
              <CloseIcon />
            </IconButton>
          </Grid>
          {/* <form onSubmit={handleSubmit(handleSubmitForm)}> */}

          <Grid item xs={12}>
          <TextField
                  label="Department Name (English)"
                  fullWidth
                  {...register("DeptNameEN", { required: "This field is required" })}
                  error={!!errors.DeptNameEN}
                  helperText={errors.DeptNameEN?.message}
                />
          </Grid>

          <Grid item xs={12}>
          <TextField
                  label="Department Name (Marathi)"
                  fullWidth
                  {...register("DeptNameMR", { required: "This field is required" })}
                  error={!!errors.DeptNameMR}
                  helperText={errors.DeptNameMR?.message}
                />
          </Grid>

          <Grid item xs={12} sm={4} textAlign={"center"}>
          <Controller
                  name="Status"
                  control={control}
                  defaultValue={1} // Default to checked (1)
                  render={({ field }) => (
                    <FormControlLabel
                      control={
                        <Checkbox
                          {...field}
                          checked={field.value === 1}
                          onChange={(e) => field.onChange(e.target.checked ? 1 : 0)}
                        />
                      }
                      label="Active"
                    />
                  )}
                />
          </Grid>
          <Grid item xs={12} sm={4} textAlign={"center"}></Grid>

          <Grid
            item
            xs={12}
            md={12}
            display="flex"
            justifyContent="space-between"
            alignItems="center"
            sx={{ position: "absolute", bottom: 10, left: 10, right: 10, mt:"10px" }}
          >
            <Button
              size="small"
              onClick={() => clearFormData()} // Cancel button functionality
              sx={{
                p: 1,
                width: 80,
                color: "rgb(0, 90, 91)",
                background: "transparent",
                border: "1px solid rgb(0, 90, 91)",
                borderRadius: "8px",
                transition: "all 0.2s ease-in-out",
                "&:hover": {
                  background: "rgba(0, 90, 91, 0.1)",
                  transform: "translateY(2px)",
                },
              }}
            >
              {ClearUpdateButton}
            </Button>
            <Button
              type="submit"
              size="small"
              // onClick={handleSubmitForm}
              sx={{
                marginTop: 1,
                p: 1,
                width: 80,
                color: "white",
                background:
                  "linear-gradient(to right, rgb(0, 90, 91), rgb(22, 149, 153))",
                boxShadow: 5,
               "&:hover": {
                      transform: "translateY(2px)",
                      boxShadow: "0 2px 4px rgba(0, 90, 91, 0.2)",
                    },
              }}
            >
              {SaveUpdateButton}
            </Button>
          </Grid>
          {/* </form> */}
          <Grid />
        </Grid>
      </Paper>
    </Modal>
    <Grid
      container
      md={12}
      lg={12}
      component={Paper}
      textAlign={"center"}
      sx={{
        width: "100%",
        px: 5,
        display: "flex",
        flexDirection: "row",
        alignItems: "center",
        justifyContent: "space-between",
        mb: 2,
      }}
      elevation={4}
    >
      <Typography
        className="slide-in-text"
        width={"100%"}
        textAlign="center"
        textTransform="uppercase"
        fontWeight="bold"
        // color={"#5C5CFF"}
        padding={1}
        noWrap
      >
        Manage Department
      </Typography>
    </Grid>
    <Grid container spacing={2} marginBottom={1} justifyContent="flex-end">
  <Grid
    item
    xs={12}
    md={4}
    lg={4}
  >
    <Button
      onClick={handleOnSave}
      type="text"
      size="medium"
      sx={{
        pr: 2,
        color: "white",
        background:
          "linear-gradient(to right, rgb(0, 90, 91), rgb(22, 149, 153))",
        borderRadius: "8px",
        transition: "all 0.2s ease-in-out",
        boxShadow: "0 4px 8px rgba(0, 90, 91, 0.3)",
        "&:hover": {
          transform: "translateY(2px)",
          boxShadow: "0 2px 4px rgba(0, 90, 91, 0.2)",
        },
        "& .MuiButton-label": {
          display: "flex",
          alignItems: "center",
        },
        "& .MuiSvgIcon-root": {
          marginRight: "10px",
        },
      }}
    >
      <AddIcon />
      Add Department
    </Button>
  </Grid>
</Grid>
    <Grid container item lg={12} component={Paper} sx={{ height: "80vh", width: "100%" }}>
      <DataGrid
        className="datagrid-style"
        sx={{
          height: "100%", // Set height in percentage
          minHeight: "500px",
          "& .MuiDataGrid-columnHeaders": {
            backgroundColor: (theme) => theme.palette.custome.datagridcolor,
          },
          "& .MuiDataGrid-row:hover": {
            boxShadow: "0px 4px 20px rgba(0, 0, 0.2, 0.2)",
          },
        }}
        rows={imgData}
        columns={columns}
        // autoHeight
        pagination
        paginationMode="server"
        rowCount={totalRows}
        pageSizeOptions={[limit]}
        paginationModel={{ page: currentPage, pageSize: limit }}
        onPaginationModelChange={(newModel) => {
          console.log("New Pagination Model:", newModel);
          setCurrentPage(newModel.page);
          getAllImgList(newModel.page, searchText);
        }}
        loading={loading}
        initialState={{
          pagination: { paginationModel: { pageSize: 8 } },

          filter: {
            filterModel: {
              items: [],

              quickFilterValues: [], // Default empty
            },
          },
        }}
        disableColumnFilter
        disableColumnSelector
        disableDensitySelector
        slots={{ toolbar: GridToolbar }} // Enables search & export
        slotProps={{
          toolbar: {
            showQuickFilter: true,

            quickFilterProps: { debounceMs: 500 },
          },
        }}
        onFilterModelChange={(model) => {
          const quickFilterValue = model.quickFilterValues?.[0] || "";
          setSearchText(quickFilterValue);
          setCurrentPage(0); // ✅ Always reset to first page when searching
          getAllImgList(0, quickFilterValue);
        }}
        getRowId={(row) => row.Id} // Ensure unique row ID from database
      />
    </Grid>
  </>
  );
};

export default Department;
